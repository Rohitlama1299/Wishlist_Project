#!/bin/bash

# Pre-commit hook to prevent committing secrets and API keys

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Patterns to detect secrets (case-insensitive)
PATTERNS=(
    'API_KEY\s*=\s*["\x27]?[A-Za-z0-9_-]{20,}["\x27]?'
    'API_SECRET\s*=\s*["\x27]?[A-Za-z0-9_-]{10,}["\x27]?'
    'SECRET_KEY\s*=\s*["\x27]?[A-Za-z0-9_-]{20,}["\x27]?'
    'PASSWORD\s*=\s*["\x27]?[^\s"'\'']{8,}["\x27]?'
    'PRIVATE_KEY'
    'aws_access_key_id'
    'aws_secret_access_key'
)

# Files to always block
BLOCKED_FILES=(
    '.env'
    '.env.local'
    '.env.prod'
    '.env.production'
    '.env.development'
)

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

FOUND_ISSUES=0

# Check for blocked files
for file in $STAGED_FILES; do
    filename=$(basename "$file")
    for blocked in "${BLOCKED_FILES[@]}"; do
        if [ "$filename" = "$blocked" ]; then
            echo -e "${RED}ERROR: Attempting to commit blocked file: $file${NC}"
            echo -e "${YELLOW}This file may contain secrets. Remove it with: git reset HEAD $file${NC}"
            FOUND_ISSUES=1
        fi
    done
done

# Check for secret patterns in staged files (excluding .example files)
for file in $STAGED_FILES; do
    # Skip example files, binary files, and git hooks
    if [[ "$file" == *.example ]] || [[ "$file" == *.png ]] || [[ "$file" == *.jpg ]] || [[ "$file" == *.ico ]] || [[ "$file" == .githooks/* ]]; then
        continue
    fi

    # Check if file exists and is readable
    if [ ! -f "$file" ]; then
        continue
    fi

    # Get the staged content
    CONTENT=$(git show ":$file" 2>/dev/null)

    for pattern in "${PATTERNS[@]}"; do
        if echo "$CONTENT" | grep -qiE "$pattern"; then
            # Don't flag if it's clearly a placeholder
            if echo "$CONTENT" | grep -iE "$pattern" | grep -qiE '(your_|example|placeholder|changeme|xxx|<.*>)'; then
                continue
            fi
            echo -e "${RED}WARNING: Potential secret found in: $file${NC}"
            echo -e "${YELLOW}Pattern matched: $pattern${NC}"
            echo -e "${YELLOW}Please review this file before committing.${NC}"
            echo ""
            FOUND_ISSUES=1
        fi
    done
done

if [ $FOUND_ISSUES -eq 1 ]; then
    echo ""
    echo -e "${RED}=== COMMIT BLOCKED ===${NC}"
    echo -e "${YELLOW}Potential secrets or sensitive files detected.${NC}"
    echo ""
    echo "To bypass this check (use with caution):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

exit 0
